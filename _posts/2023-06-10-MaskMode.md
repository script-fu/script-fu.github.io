## Mask Mode

# * Tested in GIMP 2.99.14 *
  
When working on mask painting, I'll often accidentally start painting on the layer instead. There's no current way of locking the layer pixels without also locking the mask pixels. This plug-in provides a workaround, it checks to see if the active
layer has a mask, if it does, it makes the mask active.  
  
Use the additional plugin **Mask Mode Off** to disable.  
  
The plug-ins should appear in the Tools menu.  
  
To download [**mask-mode-on.scm**](https://raw.githubusercontent.com/script-fu/script-fu.github.io/main/plug-ins/mask-mode-on/mask-mode-on.scm)  
...follow the link, right click the page, Save as mask-mode-on.scm, in a folder called mask-mode-on, in a GIMP plug-ins location.  
In Linux, set the file to be executable.
   
To download [**mask-mode-off.scm**](https://raw.githubusercontent.com/script-fu/script-fu.github.io/main/plug-ins/mask-mode-off/mask-mode-off.scm)  
...follow the link, right click the page, Save as mask-mode-off.scm, in a folder called mask-mode-off, in a GIMP plug-ins location.  
In Linux, set the file to be executable.  
  


```scheme
#!/usr/bin/env gimp-script-fu-interpreter-3.0
; Under GNU GENERAL PUBLIC LICENSE Version 3"
; Use additional plugin "Mask Mode Off" to disable.
; copyright 2023, Mark Sweeney, Under GNU GENERAL PUBLIC LICENSE Version 3


(define (script-fu-mask-mode-on img)
  (let*
    (
      (timeDelay 0.001) ; mask-mode check frequency
      (mmPID 0)(pIDf 0)(actL 0)(msk 0)
    )

    ; if mask-mode is not on
    (when (= (mask-mode-active "mask-mode-pid") 0)

      ; turn on
      (set! mmPID (mask-mode-on))

      ; mask-mode loop, while a parasite with a PID exists
      (while (> (mask-mode-match-pid "mask-mode-pid" mmPID) 0)
        (when debug
          (set! pIDf (mask-mode-match-pid "mask-mode-pid" mmPID))
          (gimp-message
            (string-append
              " \n current mask-mode PID -> " (number->string pIDf)
            )
          )
        )

        (set! actL (vector-ref (cadr(gimp-image-get-selected-layers img)) 0))
        (set! msk (car (gimp-layer-get-mask actL)))
        (if (> msk 0)(gimp-layer-set-edit-mask actL 1))

        (usleep (* 60 (* timeDelay 1000000)))
      ); mask mode loop

      (if info
        (if(= (mask-mode-match-pid "mask-mode-pid" mmPID) 0)
          (gimp-message" mask-mode is now off ")
        )
      )

    )

  )
)


(define (mask-mode-on)
   (let*
    (
      (mmPID 0)
    )

    ; create a global parasite to record the mask-mode process ID
    (srand (realtime))
    (set! mmPID (number->string (rand 1000000)))
    (gimp-attach-parasite (list "mask-mode-pid" 0 mmPID))
    (gimp-message " mask-mode on ")
    (string->number mmPID)

  )
)


(define (mask-mode-active findNme)
  (let*
    (
      (i 0)(found 0)(actP 0)
      (para (list->vector (car(gimp-get-parasite-list))))
    )

    (while (< i (vector-length para))
      (set! actP (vector-ref para i))
      (when (equal? actP findNme)
        (gimp-message " mask-mode already active ")
        (set! found 1)
        (set! i (vector-length para))
      )
      (set! i (+ i 1))
    )

    found
  )
)


(define (mask-mode-match-pid findNme PID)
  (let*
    (
      (i 0)(fndPID 0)(actP 0)(para (list->vector (car(gimp-get-parasite-list))))
    )

    (while (< i (vector-length para))
      (set! actP (vector-ref para i))
      (when (equal? actP findNme)
        (set! fndPID (string->number (caddar(gimp-get-parasite findNme))))
        (set! i (vector-length para))
      )

      (if (not (= fndPID PID)) (set! fndPID 0))
      (set! i (+ i 1))
    )

    fndPID
  )
)


(script-fu-register "script-fu-mask-mode-on"
 "Mask Mode On" 
 "Forces the active layers mask to be active"
 "Mark Sweeney"
 "Under GNU GENERAL PUBLIC LICENSE Version 3"
 "2023"
 "*"
 SF-IMAGE "Image" 0
)
(script-fu-menu-register "script-fu-mask-mode-on" "<Image>/Tools")

; debug and error tools
(define (err msg)(gimp-message(string-append " >>> " msg " <<<"))(quit))
(define (here x)(gimp-message(string-append " >>> " (number->string x) " <<<")))
(define debug #f)  ; print information
(define info #t)  ; print information
(define (boolean->string bool) (if bool "#t" "#f"))
```
  
   
```scheme
#!/usr/bin/env gimp-script-fu-interpreter-3.0
; Under GNU GENERAL PUBLIC LICENSE Version 3"
(define (script-fu-mask-mode-off)
  (let*
    (
      (i 0)(actP 0)(para (list->vector (car(gimp-get-parasite-list))))
      (PID "mask-mode-pid")
    )

    (while (< i (vector-length para))
      (set! actP (vector-ref para i))

      ; found the mask-mode process id parasite
      (when (equal? actP PID)
        (if debug (gimp-message (string-append "removing PID -> " actP)))
        (gimp-detach-parasite actP)
      )

      (set! i (+ i 1))
    )

    (if debug (gimp-message " mask mode due to go off "))

  )
)


(script-fu-register "script-fu-mask-mode-off"
 "Mask Mode Off "
 "Turns off Mask Mode"
 "Mark Sweeney"
 "Under GNU GENERAL PUBLIC LICENSE Version 3"
 "2023"
 ""
)
(script-fu-menu-register "script-fu-mask-mode-off" "<Image>/Tools")

; debug and error tools
(define (err msg)(gimp-message(string-append " >>> " msg " <<<"))(quit))
(define (here x)(gimp-message(string-append " >>> " (number->string x) " <<<")))
(define debug #f) ; print all debug information
(define (boolean->string bool) (if bool "#t" "#f"))
```